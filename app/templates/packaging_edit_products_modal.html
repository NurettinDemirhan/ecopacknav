<!-- Modal -->
<div class="modal fade" id="editLinkedProductsModal" tabindex="-1" aria-labelledby="editLinkedProductsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editLinkedProductsModalLabel">Edit Linked Products</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" id="editLinkedProductsForm">
          <input type="hidden" name="package_id" id="editLinkedPackageId">
          <input type="hidden" name="package_level" id="editLinkedPackageLevel">

          <div class="mb-3">
            <label class="form-label">Select products to link with this packaging:</label>
            <div id="linkedProductsCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ced4da; padding: 0.375rem 0.75rem; border-radius: 0.25rem;">
              {% for product in products %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="product_ids" value="{{ product._id }}" id="product_{{ product._id }}">
                  <label class="form-check-label" for="product_{{ product._id }}">
                    {{ product.product_code }}
                  </label>
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editProductsModal = document.getElementById('editLinkedProductsModal');
    if (editProductsModal) {
        const form = document.getElementById('editLinkedProductsForm');
        const packageIdInput = document.getElementById('editLinkedPackageId');
        const packageLevelInput = document.getElementById('editLinkedPackageLevel');

        editProductsModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const packageId = button.getAttribute('data-package-id');
            const packageLevel = button.getAttribute('data-package-level');
            
            packageIdInput.value = packageId;
            packageLevelInput.value = packageLevel;
            form.action = `/update_packaging_product_connections`;
            
            // Pre-select currently linked products
            fetch(`/get_packaging_details?id=${packageId}&level=${packageLevel}`)
                .then(response => response.json())
                .then(data => {
                    const linkedProductIds = data.linked_products.map(p => p._id.toString());
                    const checkboxes = document.querySelectorAll('#linkedProductsCheckboxes .form-check-input');
                    
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = linkedProductIds.includes(checkbox.value);
                    });
                });
        });
    }
});
</script>
